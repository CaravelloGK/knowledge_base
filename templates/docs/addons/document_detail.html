{% extends 'index.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'docs/css/main.css' %}">
{% endblock %}

{% block content %}

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">Оглавление</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
    </div>
    <div class="offcanvas-body">
        <ul class="toc">

            {% for heading in headings %}

            <li class="toc-item">
                <a href="#{{ heading.id }}">{{ heading.text }}</a>

                {% if heading.level < 3 %} <!-- Вложенные подразделы -->
                <ul>

                    {% for subheading in headings %}
                    <li class="toc-item">
                        <a href="#{{ subheading.id }}">{{ subheading.text }}</a>
                    </li>
                    {% endfor %}

                </ul>
                {% endif %}

            </li>

            {% endfor %}

        </ul>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample_2" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">Информация о документе</h5>
        <button type="button" class="btn-close-custom" data-bs-dismiss="offcanvas" aria-label="Закрыть">
            <img src="{% static 'img/close.svg' %}" alt="Закрыть" class="action-icon" style="width: 16px; height: 16px;">
        </button>
    </div>
    <div class="offcanvas-body">
        <!-- Действия с документом -->
        <div class="document-actions d-flex justify-content-center gap-4">
            {% if pdf_url %}
            <a href="{{ pdf_url }}" download>
                <img src="{% static 'img/download_pdf.svg' %}" alt="Скачать PDF">
                Скачать PDF
            </a>
            {% endif %}
            {% if word_file_url %}
            <a href="{{ word_file_url }}" download>
                <img src="{% static 'img/download_word.svg' %}" alt="Скачать Word" class="word-icon">
                Скачать Word
            </a>
            {% else %}
            <a href="#" data-bs-toggle="modal" data-bs-target="#noWordModal">
                <img src="{% static 'img/download_word_error.svg' %}" alt="Word недоступен" class="word-icon">
                Скачать Word
            </a>
            {% endif %}
        </div>
        <p><strong>Дата загрузки:</strong> {{ document.created_at|date:"d.m.Y" }}</p>
        <p><strong>Направление бизнеса:</strong> {{ document.global_section }}</p>
        <p><strong>Рубрика:</strong> {{ document.category }}</p>
        <!-- История версий в самом низу -->
        <div class="mt-4">
            <h5>История версий</h5>
            {% if object.versions.exists or document.file %}
            <ul class="list-group version-list mb-3">
                {% for version in object.versions.all %}
                <li class="list-group-item {% if version.id == selected_version.id or not selected_version and not show_main and document.current_version and version.id == document.current_version.id %}active{% endif %}">
                    <a href="{% url 'docs:document_detail' object.pk %}?version={{ version.id }}" class="d-flex align-items-center">
                        <span class="version-bullet"></span>
                        <span>v{{ version.version_number }} 
                        {% if version.version_date %}
                            (от {{ version.version_date|date:'d.m.Y' }})
                        {% else %}
                            (от {{ version.uploaded_at|date:'d.m.Y' }})
                        {% endif %}
                        {% if document.current_version and version.id == document.current_version.id %}
                            <span class="badge bg-success ms-2">Актуальная</span>
                        {% endif %}
                        </span>
                    </a>
                    {% if version.comment %}
                    <small class="text-muted d-block">{{ version.comment }}</small>
                    {% endif %}
                </li>
                {% endfor %}
                <!-- Основной файл как версия -->
                {% if document.file %}
                <li class="list-group-item {% if show_main or not selected_version and not document.current_version %}active{% endif %}">
                    <a href="{% url 'docs:document_detail' object.pk %}?main=true">
                        v0 (Основной документ)
                        {% if document.version_date %}
                            (от {{ document.version_date|date:'d.m.Y' }})
                        {% else %}
                            (от {{ document.updated_at|date:'d.m.Y' }})
                        {% endif %}
                        {% if not document.current_version %}
                            <span class="badge bg-success ms-2">Актуальная</span>
                        {% endif %}
                    </a>
                </li>
                {% endif %}
            </ul>
            {% else %}
            <p class="text-muted">История версий отсутствует</p>
            {% endif %}
        </div>
    </div>
</div>



<div class="container mt-4">
    <div class="card shadow-sm position-relative" style="background-color: #fff;">
        <!-- Блок иконок (админские кнопки) -->
        <div class="action-icons position-absolute top-0 end-0 m-3 d-flex align-items-center gap-3">
            <a href="{% url 'docs:document_update' pk=document.id %}{% if selected_version %}?version={{ selected_version.id }}{% endif %}" class="action-link" title="Редактировать документ">
                <img src="{% static 'img/edit.svg' %}" alt="Редактировать" class="action-icon">
            </a>
            <a href="{% url 'docs:add_document_version' pk=document.id %}" class="action-link" title="Добавить новую редакцию">
                <img src="{% static 'img/create.svg' %}" alt="Добавить редакцию" class="action-icon">
            </a>
            {% if selected_version %}
                <a href="#" data-bs-toggle="modal" data-bs-target="#deleteChoiceModal" class="action-link" title="Удалить">
                    <img src="{% static 'img/delete.svg' %}" alt="Удалить" class="action-icon">
                </a>
            {% else %}
                <a href="{% url 'docs:document_delete' pk=document.id %}" class="action-link" title="Удалить">
                    <img src="{% static 'img/delete.svg' %}" alt="Удалить" class="action-icon">
                </a>
            {% endif %}
            <a href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample_2" class="action-link" title="Информация о документе">
                <img src="{% static 'img/info.svg' %}" alt="Информация" class="action-icon">
            </a>
            {% if document.global_section.name == 'Корпоративный бизнес' %}
                <a href="{% url 'docs:kb_home' %}" class="action-link" title="Закрыть">
                    <img src="{% static 'img/close.svg' %}" alt="Закрыть" class="action-icon">
                </a>
            {% elif document.global_section.name == 'Розничный бизнес' %}
                <a href="{% url 'docs:rb_home' %}" class="action-link" title="Закрыть">
                    <img src="{% static 'img/close.svg' %}" alt="Закрыть" class="action-icon">
                </a>
            {% elif document.global_section.name == 'Административно-хозяйственная деятельность' %}
                <a href="{% url 'docs:ahd_home' %}" class="action-link" title="Закрыть">
                    <img src="{% static 'img/close.svg' %}" alt="Закрыть" class="action-icon">
                </a>
            {% elif document.global_section.name == 'Инвестиционный и международный бизнес' %}
                <a href="{% url 'docs:mb_home' %}" class="action-link" title="Закрыть">
                    <img src="{% static 'img/close.svg' %}" alt="Закрыть" class="action-icon">
                </a>
            {% elif document.global_section.name == 'Корп. управление и раскрытие информации' %}
                <a href="{% url 'docs:kuri_home' %}" class="action-link" title="Закрыть">
                    <img src="{% static 'img/close.svg' %}" alt="Закрыть" class="action-icon">
                </a>
            {% else %}
                <a href="{% url 'docs:kb_home' %}" class="action-link" title="Закрыть">
                    <img src="{% static 'img/close.svg' %}" alt="Закрыть" class="action-icon">
                </a>
            {% endif %}
        </div>

        <!-- Бейджи версий справа -->
        <div class="version-badges">
            {% if selected_version %}
                {% if selected_version.version_date %}
                    <span class="badge bg-primary">v{{ selected_version.version_number }} от {{ selected_version.version_date|date:'d.m.Y' }}</span>
                {% else %}
                    <span class="badge bg-primary">v{{ selected_version.version_number }} от {{ selected_version.uploaded_at|date:'d.m.Y' }}</span>
                {% endif %}
                {% if document.current_version and selected_version.id == document.current_version.id %}
                    <span class="badge bg-success">Актуальная редакция</span>
                {% endif %}
            {% elif show_main %}
                <span class="badge bg-secondary">v0 (Основной документ)</span>
            {% elif is_current_version and document.file %}
                <span class="badge bg-success">Актуальная редакция</span>
            {% endif %}
        </div>

        <div class="card-body">
            <h2 class="document-title d-flex align-items-center">
                {{ object.title }}
                {% if pdf_url %}
                <a href="{{ pdf_url }}" target="_blank" class="ms-2" title="Открыть в новом окне">
                    <img src="{% static 'img/external-link.svg' %}" alt="Открыть в новом окне" class="external-link-icon">
                </a>
                {% endif %}
            </h2>
            
            {% if pdf_url %}
            <div class="pdf-viewer-container" style="width:100%; height:80vh;">
                <iframe
                    id="pdfjs-viewer"
                    src="{% static 'pdfjs/web/viewer.html' %}?file={{ pdf_url|urlencode }}"
                    width="100%"
                    height="100%"
                    style="border:none;">
                </iframe>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <strong>Внимание:</strong> Файл документа не найден или недоступен.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модалка выбора действия удаления -->
{% if selected_version %}
<div class="modal fade" id="deleteChoiceModal" tabindex="-1" aria-labelledby="deleteChoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteChoiceModalLabel">Выберите действие</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <div class="d-grid gap-2">
          <a href="{% url 'docs:document_delete' pk=document.id %}" class="btn btn-outline-danger">
            Удалить весь документ "{{ document.title }}"
          </a>
          <a href="{% url 'docs:document_version_delete' document_id=document.id version_id=selected_version.id %}" class="btn btn-outline-warning">
            Удалить версию v{{ selected_version.version_number }}{% if selected_version.version_date %} от {{ selected_version.version_date|date:'d.m.Y' }}{% else %} от {{ selected_version.uploaded_at|date:'d.m.Y' }}{% endif %}
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Модалка отсутствия Word -->
<div class="modal fade" id="noWordModal" tabindex="-1" aria-labelledby="noWordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noWordModalLabel">Word-файл отсутствует</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        Для данной редакции документа не был подгружен соответствующий Word-документ. Если вам требуется Word-файл, попробуйте найти его в других редакциях документа.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ок</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'docs/js/main.js' %}"></script>
{% endblock %}