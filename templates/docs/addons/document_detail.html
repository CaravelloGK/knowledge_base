{% extends 'index.html' %}
{% block content %}

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">Оглавление</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
    </div>
    <div class="offcanvas-body">
        <ul class="toc">

            {% for heading in headings %}

            <li class="toc-item">
                <a href="#{{ heading.id }}">{{ heading.text }}</a>

                {% if heading.level < 3 %} <!-- Вложенные подразделы -->
                <ul>

                    {% for subheading in headings %}
                    <li class="toc-item">
                        <a href="#{{ subheading.id }}">{{ subheading.text }}</a>
                    </li>
                    {% endfor %}

                </ul>
                {% endif %}

            </li>

            {% endfor %}

        </ul>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample_2" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">Оглавление</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
    </div>
    <div class="offcanvas-body">
        <p><strong>Дата принятия:</strong> {{ document.created_at|date:"d.m.Y" }}</p>
        <p><strong>Статус:</strong> {{ document.get_status_display }}</p>
        <p><strong>Направление бизнеса:</strong> {{ document.global_section }}</p>
        <p><strong>Рубрика:</strong> {{ document.category }}</p>
    </div>
</div>

<script>
    $(document).ready(function() {
       $('#tocSearch').on('input', function() {
           const searchText = $(this).val().toLowerCase();

           $('.toc-item').each(function() {
               const item = $(this);
               const text = item.text().toLowerCase();

               if (text.includes(searchText)) {
                   item.show();
               } else {
                   item.hide();
               }
           });
       });
   });
</script>

<div class="container mt-4">
    <h1>{{ document.title }}</h1>
    <!-- Поле поиска -->
    <div class="mb-3">
        <input type="text" id="searchInput" placeholder="Поиск по     тексту..." class="form-control">
        <div class="mt-2">
            <button id="prevHighlight" class="btn btn-secondary">Предыдущее</button>
            <button id="nextHighlight" class="btn btn-secondary">Следующее</button>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let currentHighlightIndex = -1;
            let highlights = [];

            // Функция для подсветки текста
            function highlightText(text) {
                const content = $('#documentContent');
                content.html(content.html().replace(/<span class="highlight">(.*?)<\/span>/g, '$1')); // Убираем предыдущие подсветки
                highlights = [];
                if (text) {
                    const regex = new RegExp(`(${text})`, 'gi');
                    content.html(content.html().replace(regex, (match) => {
                        highlights.push(match);
                        return `<span class="highlight">${match}</span>`;
                    }));
                }
                currentHighlightIndex = -1;
            }

            // Обработчик ввода в поле поиска
            $('#searchInput').on('input', function() {
                const searchText = $(this).val();
                highlightText(searchText);
            });

            // Навигация между подсветками
            $('#nextHighlight').on('click', function() {
                if (highlights.length > 0) {
                    currentHighlightIndex = (currentHighlightIndex + 1) % highlights.length;
                    scrollToHighlight(currentHighlightIndex);
                }
            });

            $('#prevHighlight').on('click', function() {
                if (highlights.length > 0) {
                    currentHighlightIndex = (currentHighlightIndex - 1 + highlights.length) % highlights.length;
                    scrollToHighlight(currentHighlightIndex);
                }
            });

            // Функция для прокрутки к подсветке
            function scrollToHighlight(index) {
                const highlight = $('.highlight').eq(index);
                if (highlight.length) {
                    $('html, body').animate({
                        scrollTop: highlight.offset().top - 100
                    }, 500);
                    highlight.css('background-color', 'orange'); // Временно выделяем текущее вхождение
                    setTimeout(() => highlight.css('background-color', 'yellow'), 1000);
                }
            }
        });
    </script>

    <!-- Кнопка скачивания -->
    <div class="mb-5">
        <div class="btn-toolbar" role="toolbar" aria-label="Панель инструментов с группами кнопок">
            <div class="btn-group me-2" role="group" aria-label="Первая группа">
                <a class="btn btn-primary" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button"
                   aria-controls="offcanvasExample">
                    Оглавление
                </a>
            </div>
            <div class="btn-group me-2" role="group" aria-label="Первая группа">
                <a class="btn btn-primary" data-bs-toggle="offcanvas" href="#offcanvasExample_2" role="button"
                   aria-controls="offcanvasExample">
                    Информация о документе
                </a>
            </div>
            {% if is_template %}

            {% else %}
            <div class="btn-group" role="group" aria-label="Третья группа">
                <a href="" download class="btn btn-primary">Скачать документ</a>
            </div>
            {% endif %}


            <div class="btn-group mx-2" role="group" aria-label="Третья группа">
                <a href="javascript:history.back()" class="btn btn-primary back-button">Назад</a>
            </div>
        </div>

        <button id="scrollToTop" class="btn btn-primary" style="position:
        fixed; bottom: 20px; right: 20px; display: none;">Наверх
        </button>

    </div>


 
    <div class="document-content" id="documentContent">
            {% for para in paragraphs %}
                <p>
                    {% for run in para.runs %}
                    <span style="
                                    {% if run.bold %}font-weight: bold;{% endif %}
                                    {% if run.italic %}font-style: italic;{% endif %}
                                    {% if run.underline %}text-decoration:underline;{% endif %}">
                                    {{ run.text }}
                                </span>
                    {% endfor %}
                </p>
            {% endfor %}
                {% for table in tables %}
                <table class="table table-bordered mt-4">
                    {% for row in table %}
                    <tr>
                        {% for cell in row %}
                        <td>{{ cell|safe }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </table>
            {% endfor %}

    </div>

</div>


<!-- Подключаем jQuery для удобства -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Функция для подсветки текста
        function highlightText(text) {
            const content = $('#documentContent');
            content.html(content.html().replace(/<span class="highlight">(.*?)<\/span>/g, '$1')); // Убираем предыдущие подсветки
            if (text) {
                const regex = new RegExp(`(${text})`, 'gi');
                content.html(content.html().replace(regex, '<span class="highlight">$1</span>'));
            }}
            // Обработчик ввода в поле поиска
            $('#searchInput').on('input', function() {
                const searchText = $(this).val();
                highlightText(searchText);
            });
            $(window).scroll(function() {
                if ($(this).scrollTop() > 200) {
                    $('#scrollToTop').fadeIn();
                } else {
                    $('#scrollToTop').fadeOut();
                }
            });
            $('#scrollToTop').on('click', function() {
                $('html, body').animate({ scrollTop: 0 }, 500);
            });
            function updateTocHighlight() {
                const headings = $('h1, h2, h3'); // Выбираем все заголовки
                const scrollPosition = $(window).scrollTop();

                headings.each(function() {
                    const heading = $(this);
                    const headingTop = heading.offset().top;

                    if (headingTop <= scrollPosition + 100) {
                        const id = heading.attr('id');
                        $('.toc-item a').removeClass('active');
                        $(`.toc-item a[href="#${id}"]`).addClass('active');
                    }
                });
            };
            // Обновляем состояние при прокрутке
            $(window).scroll(updateTocHighlight);
            // Обновляем состояние при загрузке страницы
            updateTocHighlight();

            $('.toc-item').on('click', function(event) {
                if ($(event.target).is('a')) {
                    return; // Не сворачиваем, если кликнули на ссылку
                }

                const item = $(this);
                item.toggleClass('collapsed');
                item.find('ul').slideToggle();
            });

            // Инициализация: сворачиваем все подразделы
            $('.toc-item ul').hide();
            $('.toc-item').addClass('collapsed');

            // Плавная прокрутка при переходе по якорным ссылкам
            $('.toc-item a').on('click', function(event) {
                event.preventDefault();
                const target = $($(this).attr('href'));
                if (target.length) {
                    $('html, body').animate({
                        scrollTop: target.offset().top - 100
                    }, 500);
                }
            });

        // Обработчик клика по заголовкам в оглавлении
        $('.toc-item').on('click', function(event) {
            if ($(event.target).is('a')) {
                return; // Не сворачиваем, если кликнули на ссылку
            }

            const item = $(this);
            item.toggleClass('collapsed');
            item.find('ul').slideToggle(200); // Плавная анимация
        });

        // Инициализация: сворачиваем все подразделы
        $('.toc-item ul').hide();
        $('.toc-item').addClass('collapsed');
    });
</script>


{% endblock %}