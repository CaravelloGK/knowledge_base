<!-- reports/templates/reports/demo_dashboard.html -->
{% extends 'reporting/report_base.html' %}

{% block title %}Дашборд - Демо система отчетности{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-tachometer-alt"></i> Дашборд</h2>
                <div>
                    <a href="{% url 'reporting:demo_create_task' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Новая задача
                    </a>
                </div>
            </div>
            <p class="text-muted">Обзор задач и статистика</p>
        </div>
    </div>

    {% if user_profile.is_director %}
        <!-- Дашборд для директора -->
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ total_tasks }}</h4>
                                <p class="mb-0">Всего задач</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tasks fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ completed_tasks }}</h4>
                                <p class="mb-0">Завершено</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Статистика по подразделениям</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Подразделение</th>
                                        <th>Всего задач</th>
                                        <th>Завершено</th>
                                        <th>В работе</th>
                                        <th>Прогресс</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in stats %}
                                    <tr>
                                        <td>{{ stat.department.name }}</td>
                                        <td>{{ stat.total }}</td>
                                        <td>{{ stat.completed }}</td>
                                        <td>{{ stat.in_progress }}</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" style="width: 100%"></div>
                                                    {% widthratio stat.completed stat.total 100 %}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    {% elif user_profile.is_manager %}
        <!-- Дашборд для руководителя -->
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ total_tasks }}</h4>
                                <p class="mb-0">Всего задач в отделе</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ completed_tasks }}</h4>
                                <p class="mb-0">Завершено</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ overdue_tasks }}</h4>
                                <p class="mb-0">Просрочено</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Статистика по сотрудникам ({{ department.name }})</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
{#                            <table class="table table-striped">#}
{#                                <thead>#}
{#                                    <tr>#}
{#                                        <th>Сотрудник</th>#}
{#                                        <th>Всего задач</th>#}
{#                                        <th>Завершено</th>#}
{#                                        <th>Эффективность</th>#}
{#                                    </tr>#}
{#                                </thead>#}
{#                                <tbody>#}
{#                                    {% for emp in employees_tasks %}#}
{#                                    <tr>#}
{#                                        <td>{{ emp.employee.get_full_name }}</td>#}
{#                                        <td>{{ emp.total }}</td>#}
{#                                        <td>{{ emp.completed }}</td>#}
{#                                        <td>#}
{#                                            <span class="badge bg-{% if emp.total > 0 %}{% widthratio emp.completed emp.total 1 > 0.7 %}success{% else %}warning{% endif %}{% else %}secondary{% endif %}">#}
{#                                                {% if emp.total > 0 %}{% widthratio emp.completed emp.total 100 %}%{% else %}Нет задач{% endif %}#}
{#                                            </span>#}
{#                                        </td>#}
{#                                    </tr>#}
{#                                    {% endfor %}#}
{#                                </tbody>#}
{#                            </table>#}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    {% else %}
        <!-- Дашборд для сотрудника -->
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ total_tasks }}</h4>
                                <p class="mb-0">Мои задачи</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tasks fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ completed_tasks }}</h4>
                                <p class="mb-0">Завершено</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="card dashboard-card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ urgent_tasks }}</h4>
                                <p class="mb-0">Срочные</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Последние задачи</h5>
                    </div>
                    <div class="card-body">
                        {% if tasks %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Описание</th>
                                        <th>Срок</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in tasks %}
                                    <tr class="{% if task.status == 'completed' %}task-completed{% elif task.is_overdue %}task-overdue{% elif task.planned_deadline <= tomorrow %}task-urgent{% endif %}">
                                        <td>{{ task.description|truncatewords:10 }}</td>
                                        <td>{{ task.planned_deadline }}</td>
                                        <td>
                                            <span class="badge bg-{% if task.status == 'completed' %}success{% elif task.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
                                                {{ task.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <a href="{% url 'reporting:demo_update_task' task.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">У вас пока нет задач. <a href="{% url 'demo_create_task' %}">Создайте первую задачу</a></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}