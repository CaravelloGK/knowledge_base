{% extends 'index.html' %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}

{% block content %}
    <style>
        .form-switch .form-check-input {
            background-color: #c5c5c5;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.1rem #b6d4fe;
        }

        .form-switch .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.1rem #b6d4fe;
        }

        .form-switch .form-check-input:focus {
            box-shadow: 0 0 0 0.2rem #badcff80;
        }
    </style>
    <div class="row justify-content-center my-2">
        <div class="col-lg-7 col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white fw-semibold d-flex align-items-center">
                    <svg width="1.25em" height="1.25em" fill="none" class="me-2" viewBox="0 0 24 24">
                        <rect x="4" y="5" width="16" height="14" rx="2" stroke="#fff" stroke-width="1.5"/>
                        <path d="M8 3v4M16 3v4" stroke="#fff" stroke-width="1.5"/>
                        <rect x="8" y="11" width="8" height="2" rx="1" fill="#fff" fill-opacity=".25"/>
                    </svg>
                    {% if is_create %}Создание{% else %}Редактирование{% endif %} сделки
                </div>
                <form method="post" class="card-body">
                    {% csrf_token %}

                    <!-- Группа: Основные условия -->
                    <h6 class="text-uppercase fw-semibold small mb-2 border-start border-3 border-primary ps-2">Основные
                        параметры</h6>
                    <div class="row g-3 align-items-end">

                        <div class="col-md-4">
                            <label for="{{ form.bid_number.id_for_label }}" class="form-label fw-semibold">
                                <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">
                                    <text x="0" y="12" font-size="13" fill="#0d6efd">#</text>
                                </svg>
                                № заявки
                            </label>
                            {{ form.bid_number|add_class:"form-control" }}
                            {% if form.bid_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.bid_number.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.bid_date.id_for_label }}" class="form-label fw-semibold">
                                <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">
                                    <rect x="2" y="4" width="12" height="10" rx="2" stroke="#0d6efd"/>
                                    <rect x="4.5" y="2" width="1" height="2.5" fill="#0d6efd"/>
                                    <rect x="10.5" y="2" width="1" height="2.5" fill="#0d6efd"/>
                                </svg>
                                Дата
                            </label>
                            {{ form.bid_date|add_class:"form-control" }}
                            {% if form.bid_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.bid_date.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.bid_initiator.id_for_label }}" class="form-label fw-semibold">
                                <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">
                                    <circle cx="8" cy="6" r="3" stroke="#0d6efd"/>
                                    <path d="M2 14c0-2.5 6-2.5 6-2.5s6 0 6 2.5" stroke="#0d6efd"/>
                                </svg>
                                Инициатор
                            </label>
                            {{ form.bid_initiator|add_class:"form-control" }}
                            {% if form.bid_initiator.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.bid_initiator.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-12">
                            <label for="{{ form.bid_theme.id_for_label }}" class="form-label fw-semibold">
                                <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">
                                    <path d="M3 2.5h10M3 5.5h10M3 8.5h10M3 11.5h10" stroke="#20c997"/>
                                </svg>
                                Тема сделки
                            </label>
                            {{ form.bid_theme }}
                            {% if form.bid_theme.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.bid_theme.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-12">
                            <label for="{{ form.credit_product.id_for_label }}" class="form-label fw-semibold">
                                <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">
                                    <rect x="2" y="5" width="12" height="8" rx="2" stroke="#198754"/>
                                </svg>
                                Кредитный продукт
                            </label>
                            {{ form.credit_product|add_class:"form-select" }}
                            {% if form.credit_product.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.credit_product.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.amount.id_for_label }}" class="form-label fw-semibold">
                                <svg width="1em" height="1em" class="me-1" viewBox="0 0 14 14">
                                    <text x="0" y="11" font-size="12" fill="#198754">₽</text>
                                </svg>
                                Сумма
                            </label>
                            <div class="input-group">
                                <span class="input-group-text text-success bg-light"><svg width="1em" height="1em"
                                                                                          viewBox="0 0 14 14"><text
                                        x="0" y="11" font-size="12" fill="#198754">₽</text></svg></span>
                                {{ form.amount|add_class:"form-control" }}
                            </div>
                            {% if form.amount.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.amount.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.term.id_for_label }}" class="form-label fw-semibold">
                                <svg width="1em" height="1em" class="me-1" viewBox="0 0 20 20">
                                    <circle cx="10" cy="10" r="9" stroke="#fd7e14"/>
                                    <path d="M10 7v4l3 2" stroke="#fd7e14"/>
                                </svg>
                                Срок
                            </label>
                            {{ form.term|add_class:"form-control" }}
                            {% if form.term.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.term.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Группа чекбоксов (switch) -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.commission|add_class:"form-check-input" }}
                                <label class="form-check-label fw-semibold ms-2"
                                       for="{{ form.commission.id_for_label }}">
{#                                    <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">#}
{#                                        <rect x="3" y="5" width="10" height="6" rx="2" stroke="#0d6efd"/>#}
{#                                    </svg>#}
                                    Предусмотрена комиссия
                                </label>
                                {% if form.commission.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.commission.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.commission_is_law|add_class:"form-check-input" }}
                                <label class="form-check-label fw-semibold ms-2"
                                       for="{{ form.commission_is_law.id_for_label }}">
{#                                    <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">#}
{#                                        <circle cx="8" cy="8" r="7" stroke="#198754"/>#}
{#                                        <path d="M6 8l2 2 3-3" stroke="#198754"/>#}
{#                                    </svg>#}
                                    Комиссия соответствует закону
                                </label>
                                {% if form.commission_is_law.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.commission_is_law.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Группа: Дополнительные параметры (скрываются/появляются через js как раньше) -->
                    <div class="my-4 pt-2 border-top" id="additional-fields-block">
                        <h6 class="text-uppercase fw-semibold small mb-3 border-start border-3 border-success ps-2">
                            Дополнительные параметры</h6>
                        <div class="row g-3">
                            <div class="col-md-6" id="field_postponement">
                                {{ form.postponement.label_tag }}{{ form.postponement|add_class:"form-control" }}
                                {% if form.postponement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.postponement.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6" id="field_waiting_period">
                                {{ form.waiting_period.label_tag }}{{ form.waiting_period|add_class:"form-control" }}
                                {% if form.waiting_period.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.waiting_period.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6" id="field_object_of_financing">
                                {{ form.object_of_financing.label_tag }}{{ form.object_of_financing|add_class:"form-control" }}
                                {% if form.object_of_financing.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.object_of_financing.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6" id="field_financing_structure">
                                {{ form.financing_structure.label_tag }}{{ form.financing_structure|add_class:"form-control" }}
                                {% if form.financing_structure.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.financing_structure.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6" id="field_secured_obligation">
                                {{ form.secured_obligation.label_tag }}{{ form.secured_obligation|add_class:"form-control" }}
                                {% if form.secured_obligation.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.secured_obligation.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6" id="field_beneficiary">
                                {{ form.beneficiary.label_tag }}{{ form.beneficiary|add_class:"form-control" }}
                                {% if form.beneficiary.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.beneficiary.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Комментарий/описание -->
                    <div class="mb-2">
                        <label for="{{ form.dop_info.id_for_label }}" class="form-label fw-semibold">
{#                            <svg width="1em" height="1em" class="me-1" viewBox="0 0 16 16">#}
{#                                <rect x="2" y="5" width="12" height="6" rx="2" stroke="#fec107"/>#}
{#                                <path d="M3 10l3 3h4l3-3" stroke="#fec107"/>#}
{#                            </svg>#}
                            Комментарий
                        </label>
                        {{ form.dop_info|add_class:"form-control" }}
                        {% if form.dop_info.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.dop_info.errors.0 }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="" class="btn btn-outline-secondary" onclick="window.history.back(); return false;">
                            <svg width="1em" height="1em" fill="none" class="me-1" viewBox="0 0 16 16">
                                <path d="M3.5 3.5l9 9m-9 0l9-9" stroke="#6c757d" stroke-width="1.2"/>
                            </svg>
                            Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <svg width="1em" height="1em" fill="none" class="me-1" viewBox="0 0 16 16">
                                <rect x="2" y="4" width="12" height="9" rx="2" stroke="#fff" stroke-width="1.2"/>
                                <path d="M5 4V2h6v2" stroke="#fff" stroke-width="1.2"/>
                            </svg>
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JS для динамики дополнительных полей -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function toggleFields() {
                var cp = document.getElementById('id_credit_product');
                if (!cp) return;

                var val = cp.options[cp.selectedIndex].text.toLowerCase();
                ['field_postponement', 'field_waiting_period', 'field_object_of_financing', 'field_financing_structure', 'field_secured_obligation', 'field_beneficiary'
                ].forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                if (val.indexOf('факторинг') !== -1) {
                    ['field_postponement', 'field_waiting_period'].forEach(function (id) {
                        var el = document.getElementById(id);
                        if (el) el.style.display = '';
                    });
                }
                if (val.indexOf('синдиц') !== -1 || val.indexOf('проект') !== -1 || val.indexOf('бридж') !== -1) {
                    ['field_object_of_financing', 'field_financing_structure'].forEach(function (id) {
                        var el = document.getElementById(id);
                        if (el) el.style.display = '';
                    });
                }
                if (val.indexOf('гарантия') !== -1 || val.indexOf('аккредитив') !== -1) {
                    ['field_secured_obligation', 'field_beneficiary'].forEach(function (id) {
                        var el = document.getElementById(id);
                        if (el) el.style.display = '';
                    });
                }
            }

            var cp = document.getElementById('id_credit_product');
            if (cp) {
                cp.addEventListener('change', toggleFields);
                toggleFields();
            }
            // Auto-resize для комментария (если dop_info — textarea)
            var ta = document.getElementById('id_dop_info');
            if (ta) {
                ta.setAttribute('rows', 1);
                ta.style.overflow = 'hidden';
                ta.addEventListener('input', function () {
                    this.style.height = '';
                    this.style.height = (this.scrollHeight + 2) + 'px';
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var ta = document.getElementById('id_bid_theme');
            if (ta) {
                ta.setAttribute('rows', 1);
                ta.style.overflow = 'hidden';
                ta.addEventListener('input', function () {
                    this.style.height = '';
                    this.style.height = (this.scrollHeight + 2) + 'px';
                });
                // Если текст автозаполнен (редактирвание) — мэтч стартовую высоту:
                ta.style.height = '';
                ta.style.height = (ta.scrollHeight + 2) + 'px';
            }
        });
    </script>
{% endblock %}