{% load static %}
<link rel="stylesheet" href="{% static 'legal_opin/css/main.css' %}">
<script src="{% static 'legal_opin/js/deal_main.js' %}"></script>

<div class="container-fluid">
    <div class="row">
        <div class="col">
                         <div class="container mt-4">
                 <!-- Контейнер для карточек сделок -->
                 <div id="deals-container">
                        {% for deal in deals %}
                        <div class="card mb-3 shadow-sm position-relative entity-card deal-card" style="overflow-x: hidden"
                             data-deal-number="{{ deal.bid_number|lower }}"
                             data-deal-credit-product="{{ deal.credit_product.name|default:""|lower }}"
                             data-deal-borrowers="{% for borrower in deal.borrowers %}{{ borrower.name|lower }}{% if not forloop.last %} {% endif %}{% endfor %}"
                             data-deal-created="{{ deal.bid_date|date:"Y-m-d" }}">
                            <div class="card-body">
                                <!-- Строка 1: Тип сделки (слева) + Дата и номер (справа) -->
                                <div class="d-flex align-items-center mb-2">
                                    <div>
                                        <span class="badge bg-primary">{{ deal.credit_product.name|default:"Сделка" }}</span>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted ms-1">| Создано</small>
                                        <small class="text-muted fw-bold"> {% if deal.created_at %}{{ deal.created_at|date:"d.m.Y H:i" }}{% endif %} </small>
                                        <small class="text-muted ms-1">| Номер</small>
                                        <small class="text-muted fw-bold"> {{ deal.bid_number }} </small>
                                    </div>
                                </div>
                                
                                <!-- Строка 2: Числовые показатели -->
                                <div class="mb-2">
                                    <span class="text-muted small">Сумма:</span> <span class="deal-amount fw-medium">{{ deal.amount|default_if_none:""|floatformat:0 }}{% if deal.amount %} ₽{% else %}-{% endif %}</span>
                                    <span class="text-muted small ms-3">Срок:</span> <span class="fw-medium">{% if deal.term %}{{ deal.term }} мес.{% else %}-{% endif %}</span>
                                </div>
                                
                                <!-- Строка 3: Инициатор -->
                                <div class="d-flex align-items-center">
                                    <div>
                                        <strong class="small text-muted ms-1">Инициатор:</strong>
                                                <span class="badge bg-light text-dark border me-1">{{ deal.bid_initiator }}</span>
                                    </div>
                                </div>
                                <!-- Строка 3: Должники -->
{#                                <div class="d-flex align-items-center">#}
{#                                    <div>#}
{#                                        <strong class="small text-muted ms-1">Клиент:</strong>#}
{#                                        {% if deal.borrowers %}#}
{#                                            {% for borrower in deal.borrowers %}#}
{#                                                <span class="badge bg-light text-dark border me-1">{{ borrower.name|truncatechars:90 }}</span>#}
{#                                            {% endfor %}#}
{#                                        {% else %}#}
{#                                            <span class="text-muted">-</span>#}
{#                                        {% endif %}#}
{#                                    </div>#}
{#                                </div>                            #}
                                
                                <a href="{% url 'legal_opin:deal_detail' deal.pk %}" class="stretched-link"></a>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5">
                            <i class="bi bi-file-earmark-text text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">Сделок пока нет</p>
                            <a href="{% url 'legal_opin:deal_create' %}" class="btn btn-new-deal">
                                <i class="bi bi-plus-circle me-2"></i>Создать первую сделку
                            </a>
                        </div>
                        {% endfor %}
                 </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Форматирование сумм с разделителями тысяч
    document.querySelectorAll('.deal-amount').forEach(el => {
        const text = el.textContent;
        const match = text.match(/(\d+)\s*₽/);
        if (match) {
            const number = match[1].replace(/\D/g, '');
            const formatted = number.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            el.innerHTML = text.replace(match[1], formatted);
        }
    });
});
</script>